#include "stm8s.h"
#include "event.h"

#define NOTE_MASK 0x1F
#define NOTE_VIBRATO 0x20
#define NOTE_OCTAVE  0x40
#define NOTE_SHORT   0x80

const uint8_t MelodyArray[] = {
0xCB,0xDF,0xC8,0xDF,0xC4,0xDF,0xC0,0xDF,0xC0,0x99,0x96,0x96,0x90,0x96,0x96,0x8B,
0xCB,0xDF,0xC8,0xDF,0xC4,0xDF,0xC0,0xDF,0xC0,0x99,0x96,0x96,0x90,0x8B,0x8B,0x8B,
0x80,0x8B,0x8B,0x90,0x93,0x99,0x99,0x93,0x90,0x8B,0x8B,0x86,0x82,0x80,0x80,0xDF,
0x80,0x8B,0x8B,0x90,0x93,0x99,0x99,0x93,0x99,0xC0,0xC0,0x93,0x99,0xC0,0xC0,0xC0,
0x96,0x96,0x96,0x96,0x84,0x88,0x8B,0x90,0x96,0x96,0x96,0x96,0x84,0x88,0x8B,0x90,
0x96,0x96,0xCB,0xCB,0xC8,0xC8,0xC4,0xC4,0x96,0x96,0x96,0x96,0xDF,0xDF,0xDF,0xDF,
0x90,0x90,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC9,0xC0,0x9C,0x9C,0x9C,0x9C,0x9C,0x9C,
0xC0,0x9C,0x96,0x96,0x96,0x96,0x96,0x96,0x8B,0x88,0x84,0x84,0x84,0x84,0x84,0x84,
0xC6,0xC2,0x8D,0xDF,0xCD,0xDF,0xCD,0xDF,0xC6,0xC2,0x8D,0xDF,0xCD,0xDF,0xCD,0xDF,
0xC6,0xC2,0x8D,0xDF,0xCD,0xDF,0x86,0xDF,0xCD,0xDF,0x82,0xDF,0xCB,0xDF,0xCB,0xDF,
0x84,0x84,0x99,0x99,0x99,0x99,0x99,0x99,0x96,0x90,0x96,0x96,0x96,0x96,0x96,0x96,
0x84,0x84,0x96,0x96,0x96,0x96,0x96,0x96,0x99,0x96,0x90,0x90,0x90,0x90,0x90,0xDF,
0x90,0x8D,0x90,0x86,0x84,0x80,0x80,0x80,0x90,0x8D,0x90,0x86,0x84,0x80,0x80,0x80,
0x90,0x8D,0x90,0x93,0xDF,0x90,0xDF,0x86,0xDF,0x80,0xDF,0x84,0x84,0xDF,0xDF,0xDF,
0xD0,0xD3,0xD0,0xD0,0xC0,0xC4,0xC6,0xC0,0xD0,0xD3,0xD0,0xD0,0xC4,0xC6,0xCB,0xC4,
0xD0,0xD3,0xD0,0xD0,0xC4,0xC6,0xCB,0xCB,0xD0,0xD3,0xD0,0xD0,0xDF,0xDF,0xDF,0xDF,
0x96,0x96,0x90,0x8B,0x88,0x8B,0x90,0x90,0xDF,0x90,0x8B,0x88,0x84,0x88,0x8B,0x8B,
0xDF,0x8B,0x88,0x88,0xDF,0x88,0x99,0x99,0xDF,0x99,0x96,0x90,0x8B,0x88,0x84,0xDF,
0x96,0x96,0x88,0x96,0x88,0x96,0x88,0x96,0xC0,0xC0,0x96,0xC0,0x96,0xC0,0x96,0xC0,
0xC8,0xC8,0xC0,0xC8,0xC4,0xC4,0x9C,0xC4,0xC0,0xC0,0x96,0xC0,0x9C,0x9C,0xC8,0xC8,
0x08,0x16,0x40,0x1C,0x16,0x40,0x16,0x1C,0x16,0x0B,0x16,0x08,0x08,0x08,0xDF,0x08,
0x16,0x40,0x1C,0x16,0x40,0x16,0x1C,0x16,0x0B,0x08,0x04,0x04,0x04,0x04,0xDF,0xDF,
0x48,0x4B,0x44,0x44,0x40,0x40,0x1C,0x16,0x50,0x56,0x50,0x50,0x4B,0x5F,0x4B,0x5F,
0x40,0x44,0x40,0x40,0x1C,0x1C,0x16,0x10,0x4B,0x50,0x4B,0x4B,0x48,0x5F,0x48,0x5F,
0xC8,0xCB,0xC8,0xCB,0xC8,0xCB,0xC8,0xC4,0xC4,0x9C,0x9C,0xDF,0xCB,0xC8,0xC4,0xC4,
0x9C,0x9C,0xDF,0xD0,0xCB,0xCB,0xCB,0xCB,0xC8,0xC8,0xC8,0xDF,0xDF,0xDF,0xDF,0xDF,
0x96,0xD0,0xD0,0xCB,0x96,0xD0,0xCB,0x96,0xD0,0xD0,0xCB,0xCB,0xCB,0xDF,0xDF,0x96,
0xCB,0xCB,0xC8,0x96,0xCB,0xC8,0x96,0xCB,0xCB,0xC8,0xC8,0xC8,0xDF,0xDF,0xDF,0xDF,
0xC0,0xC0,0x9C,0x9C,0x96,0x96,0x93,0x93,0x93,0x96,0x9C,0x9C,0x9C,0x9C,0xDF,0x88,
0x93,0x9C,0xCB,0xC8,0xCB,0xC8,0x96,0x96,0x96,0x9C,0xC0,0xC0,0xC0,0xC0,0xDF,0xDF,
0xC2,0xC6,0xC8,0xC6,0xC2,0x9C,0xC6,0xDF,0xDF,0xDF,0xC6,0xC6,0xC6,0xDF,0xDF,0xC2,
0xC6,0xC8,0xC6,0xC2,0xC6,0xC2,0xDF,0xDF,0xDF,0x9C,0x9C,0x9C,0xDF,0xDF,0xDF,0xDF,
0x96,0xC0,0x96,0xC0,0xC4,0xC4,0xC0,0x9C,0x96,0xC0,0x96,0xC0,0xC4,0xC4,0xC0,0x9C,
0x96,0x96,0x96,0xD6,0xD0,0xCB,0xC8,0xC4,0xC0,0xC0,0xC0,0xC0,0xDF,0xDF,0xDF,0xDF,
0xC0,0xC4,0xC8,0xC8,0xC0,0xC4,0xC8,0xC4,0xC0,0x9C,0x96,0x9C,0xC0,0xC4,0x9C,0x90,
0xC0,0xC4,0xC8,0xC8,0xC0,0xC4,0xC8,0xC4,0xC0,0x9C,0x96,0xC4,0x9C,0x90,0xC0,0xC0,
0xED,0xED,0xED,0xF0,0xF6,0xF6,0xFC,0xFC,0xF0,0xF0,0xE8,0xE8,0xFC,0xFC,0xF6,0xF0,
0xED,0xED,0xED,0xF0,0xF6,0xF6,0xFC,0xFC,0xF0,0xF0,0xE8,0xFF,0xE8,0xE8,0xE8,0xFF,
0xF6,0xEB,0xF9,0xF6,0xF6,0xEB,0xE8,0xE4,0xF0,0xE8,0xF6,0xF0,0xF0,0xF0,0xFF,0xFF,
0xF0,0xE8,0xF6,0xF0,0xF0,0xF6,0xF0,0xF6,0xE4,0xE4,0xE4,0xE4,0xFF,0xFF,0xFF,0xFF,
0x9C,0x96,0x96,0xC0,0xC8,0xD0,0xCB,0xCB,0xC0,0x9C,0x9C,0xC8,0x9C,0xC0,0xC0,0xC0,
0x9C,0x96,0x96,0xC0,0xC8,0xD6,0xDC,0xDC,0xD6,0xD0,0xD0,0xC4,0xCB,0xC8,0xC8,0xC8,
0x96,0xC0,0x90,0x90,0x90,0x90,0x90,0x90,0x96,0xC0,0x8B,0x8B,0x8B,0x8B,0x8B,0x8B,
0x90,0x96,0x99,0x99,0x90,0x90,0x88,0x88,0x90,0x90,0x8B,0x8B,0x8B,0x8B,0x8B,0x8B,
0x99,0x99,0x99,0x99,0xC0,0xC0,0x99,0x99,0x96,0x96,0x90,0x90,0x90,0x90,0x8B,0x90,
0x96,0x96,0x96,0x96,0x99,0x99,0x96,0x96,0x90,0x90,0x8B,0x8B,0x8B,0x8B,0x9F,0x9F,
0xC4,0xC8,0xD0,0xCB,0xD0,0xCB,0x9C,0x9C,0xC0,0xC4,0xCB,0xC8,0xCB,0xC8,0x96,0x96,
0x9C,0xC0,0xC8,0xC8,0xC4,0xC4,0xC0,0x9C,0xC4,0xC0,0x96,0x96,0x96,0x96,0x96,0xDF,
0x96,0x9C,0xC2,0xC4,0xC4,0x96,0x96,0xC0,0x99,0x96,0x90,0x8B,0x8B,0x84,0x84,0x9F,
0x84,0x88,0x8B,0x90,0x90,0x99,0x99,0x96,0x90,0x8B,0x90,0x96,0x96,0x96,0x96,0x96,
0xC8,0xC4,0xC0,0xC0,0x96,0x96,0x93,0x93,0x96,0x96,0x9C,0x9C,0x88,0x88,0x88,0x88,
0xC8,0xC4,0xC0,0xC0,0x96,0x96,0xD6,0xD6,0xD6,0xD0,0xCB,0xCB,0xCB,0xCB,0xCB,0xCB,
0x96,0xCB,0xC8,0xC4,0xC8,0xCB,0xD6,0xD0,0xC4,0xC8,0xC8,0xC8,0x96,0xD0,0xCB,0xC8,
0xD0,0xCB,0xC8,0xC4,0xC8,0xCB,0xCB,0xCB,0xCB,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,
0x96,0x96,0x96,0x96,0x99,0x96,0xCB,0xCB,0xCB,0xCB,0xC8,0xC4,0xC2,0xC2,0xC2,0xC2,
0xC8,0xC2,0x96,0x96,0x96,0x96,0x96,0x96,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,
0x9C,0xC0,0x9C,0x90,0x88,0x90,0x90,0x8D,0x96,0x9C,0x96,0x8D,0x96,0xC0,0xC0,0x9C,
0xC4,0xC8,0xC4,0x9C,0x90,0x9C,0x9C,0x96,0x96,0x9C,0x96,0x9C,0xC0,0xC4,0xC4,0xC4,
0xC4,0xC0,0xC4,0x96,0x8B,0x96,0x84,0x84,0xC4,0xC0,0xC4,0x96,0x8B,0x96,0x84,0x84,
0xC4,0xC8,0xCB,0xC8,0xCB,0xC4,0xC8,0xC4,0xC8,0xC0,0xC4,0xC0,0xC4,0x96,0xC4,0xC4,
0x96,0x96,0x96,0x96,0x8B,0x90,0x96,0x96,0x96,0x96,0x96,0xDF,0x96,0x90,0x96,0xCB,
0xCB,0xC8,0xC4,0xC4,0xC4,0xC4,0xC4,0xC4,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,
0x96,0x9C,0xC0,0xC4,0xC8,0xC8,0xC0,0x9C,0x96,0x96,0x93,0x96,0xC0,0xC0,0x9C,0xDF,
0x9C,0xC0,0xC4,0xC8,0xD0,0xD0,0xCB,0xC8,0xC4,0xC4,0xC0,0xC4,0xC8,0xC8,0xC8,0xC8
#if !defined(ONLY32MELODY)
,
0x8B,0x96,0xCB,0xC8,0xC4,0x96,0x99,0x96,0x8B,0x8B,0x8B,0x8B,0xDF,0x8B,0x96,0xCB,
0xC8,0xC4,0x96,0x99,0x96,0xC0,0xC0,0x99,0x99,0x99,0x99,0xDF,0xDF,0xDF,0xDF,0xDF,
0x8B,0x8B,0x84,0x84,0x96,0x99,0x96,0x90,0x8B,0x88,0x84,0x84,0x84,0x84,0x8B,0x8B,
0x96,0x96,0xC0,0xC4,0xC0,0x99,0x96,0x96,0x96,0x96,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,
0xB0,0xB0,0xB6,0xB6,0xBC,0xBC,0xE4,0xE4,0xE4,0xE4,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,
0xE4,0xE0,0xB0,0xB0,0xA6,0xA6,0xB0,0xB0,0xB0,0xB0,0xAB,0xAB,0xAB,0xAB,0xAB,0xAB,
0x80,0x8B,0x8B,0x8B,0x90,0x99,0x93,0x90,0x8B,0xC2,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,
0x8B,0x99,0x99,0x99,0xC0,0xC6,0xC2,0xC0,0x99,0xC2,0xC2,0xC2,0xC2,0xC2,0xDF,0xDF,
0x90,0x96,0x9C,0xC0,0xC0,0x90,0x90,0x90,0x90,0xC4,0xC6,0xC0,0xC0,0x90,0x90,0x90,
0xDF,0x90,0x93,0x99,0x99,0x96,0x99,0xC0,0xC0,0x99,0x93,0x93,0x93,0x90,0x90,0x90,
0x8D,0x8B,0x8D,0x84,0x84,0x84,0x84,0x84,0x9C,0x99,0x9C,0x90,0x90,0x90,0x90,0xDF,
0x90,0x8D,0x8B,0x88,0x88,0x88,0x88,0xDF,0x88,0x9C,0x88,0x96,0x96,0x96,0x96,0x96,
0x99,0xC0,0xC2,0xC6,0xC6,0xCB,0xCB,0xCB,0xDF,0xCB,0xC6,0xC2,0xCB,0xCB,0xC0,0xC0,
0xC0,0xC0,0xC2,0xC2,0xC0,0xC0,0x8B,0x90,0x93,0x93,0x90,0x90,0x8B,0x8B,0x8B,0x8B,
0xD0,0xD0,0xCB,0xCB,0xC6,0xC4,0xC4,0xC4,0xD3,0xD3,0xD0,0xD0,0xC6,0xC0,0xC0,0xC0,
0xC6,0xC6,0xC4,0xC4,0xC0,0xC0,0x9C,0x9C,0xD3,0xD3,0xD0,0xD0,0xD0,0xD0,0xDF,0xDF,
0x04,0x0B,0x16,0x0B,0x10,0x10,0x0B,0x08,0x16,0x16,0x10,0x10,0x04,0x04,0x04,0x04,
0x0B,0x16,0x40,0x40,0x44,0x44,0x40,0x19,0x16,0x16,0x16,0x16,0x16,0x5F,0x5F,0xDF,
0xEB,0xEB,0xEB,0xF0,0xF6,0xF6,0xF0,0xEB,0xE8,0xE4,0xE8,0xEB,0xF0,0xF0,0xE0,0xE0,
0xEB,0xEB,0xEB,0xF0,0xF6,0xF6,0xF0,0xEB,0xE8,0xE4,0xE8,0xEB,0xF0,0xF0,0xF0,0xF0,
0x8B,0x84,0x8B,0x99,0x99,0x99,0x99,0x99,0x96,0x90,0x84,0x8B,0x8B,0x8B,0x8B,0x8B,
0xDF,0x8B,0x8B,0x90,0x90,0x90,0x90,0x90,0x8B,0x86,0x84,0x8B,0x8B,0x86,0x86,0x86,
0x8B,0x90,0x93,0x93,0x8B,0x90,0x93,0x93,0x8B,0x90,0x93,0x8B,0x90,0x90,0x90,0x90,
0x88,0x8B,0x90,0x90,0x88,0x8B,0x90,0x90,0xC0,0x99,0x93,0x90,0x8B,0x8B,0x8B,0x8B,
0xE0,0xE2,0xE0,0xB9,0xB3,0xB3,0xAB,0xAB,0xB9,0xFF,0xB3,0xAB,0xAB,0xAB,0xAB,0xB9,
0xFF,0xB3,0xAB,0xAB,0xAB,0xAB,0xA8,0xA0,0xA8,0xAB,0xAB,0xAB,0xAB,0xFF,0xFF,0xFF,
0xCB,0xCB,0xC0,0xCB,0xC6,0xC2,0x99,0x99,0xC2,0xC0,0x90,0x90,0xC2,0xC0,0x93,0x93,
0xCB,0xCB,0xC8,0xCB,0xD0,0xCB,0xC0,0xDF,0xC0,0xD3,0xD0,0xD3,0xCB,0xCB,0xCB,0xCB,
0x84,0x84,0x86,0x84,0x90,0x90,0x96,0x90,0x99,0x99,0x99,0x99,0x99,0x99,0x99,0x99,
0x84,0x84,0x90,0x99,0xC4,0xC4,0xC6,0xC4,0x96,0x96,0x96,0x96,0x96,0x96,0x96,0x96,
0xC0,0xC0,0x99,0x99,0x99,0x99,0xC2,0xC6,0xCB,0xC6,0xC2,0xC0,0xC0,0xC0,0xDF,0xC0,
0xC0,0x99,0x99,0x99,0x99,0x90,0x93,0x99,0x93,0x90,0x8B,0x8B,0x8B,0x8B,0xDF,0xDF,
0x60,0x3C,0x36,0x36,0x36,0x3C,0x60,0x36,0x60,0x6D,0x68,0x68,0x3C,0x3C,0x3C,0x3C,
0x30,0x28,0x64,0x64,0x64,0x60,0x3C,0x60,0x3C,0x36,0x68,0x68,0x68,0x68,0x7F,0x7F,
0x62,0x62,0x62,0x62,0x62,0x36,0x33,0x2D,0x24,0x24,0x3C,0x3C,0x3C,0x7F,0x3C,0x3C,
0x3C,0x3C,0x3C,0x33,0x2D,0x28,0x36,0x36,0x36,0x36,0x33,0x33,0x33,0x33,0x7F,0x7F,
0x30,0x36,0x30,0x28,0x28,0x28,0x28,0x28,0x30,0x68,0x60,0x64,0x64,0x64,0x64,0x64,
0x30,0x36,0x30,0x6B,0x6B,0x6B,0x6B,0x6B,0x30,0x36,0x3C,0x60,0x60,0x60,0x60,0x60,
0xB3,0xB3,0xB3,0xB3,0xAB,0xAB,0xB3,0xB3,0xB0,0xB0,0xB0,0xB0,0xA0,0xA0,0xFF,0xA0,
0xB3,0xB0,0xAB,0xA6,0xAB,0xAB,0xE0,0xE0,0xB0,0xB0,0xB0,0xB0,0xA0,0xA0,0xA0,0xA0,
0x90,0x8B,0x86,0x90,0x99,0xC2,0xC0,0x99,0x93,0x93,0x93,0x93,0xDF,0x90,0x8B,0x86,
0x90,0x99,0xCB,0xCB,0xCB,0xC6,0xC6,0xC2,0xC0,0xC0,0xC0,0xC0,0xDF,0xDF,0xDF,0xDF,
0x90,0x90,0x93,0x99,0x99,0x93,0x90,0x8B,0x8B,0x99,0x99,0xDF,0x8B,0x8B,0x90,0x93,
0x93,0x90,0x8B,0x90,0x90,0x86,0x86,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,
0x88,0x8B,0x88,0x86,0x88,0x80,0x80,0x80,0x88,0x8B,0x88,0x86,0x88,0x80,0x80,0x80,
0x88,0xC0,0x9C,0x96,0x88,0x90,0x8B,0x88,0x8B,0x88,0x84,0x84,0x82,0x84,0x84,0x84,
0x96,0x9C,0x96,0x96,0x88,0x88,0x88,0x88,0x96,0x9C,0x96,0x96,0x88,0x88,0x88,0x88,
0xC0,0xC0,0xC0,0x88,0xC0,0x9C,0x96,0x90,0x8B,0x8B,0x8B,0x8B,0x8B,0x8B,0xDF,0xDF,
0x93,0x99,0xC0,0xC0,0x93,0x99,0xC0,0xC0,0x93,0x99,0xC0,0xC0,0x99,0x93,0x90,0x90,
0x90,0x86,0x84,0x84,0x8B,0x93,0xC0,0xC0,0x99,0x93,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,
0xC8,0xC0,0x96,0x8D,0x88,0x8D,0x90,0x9C,0xC8,0xC8,0x9C,0x9C,0x9C,0x9C,0xDF,0xC8,
0xC0,0x96,0x8D,0x88,0x8D,0x90,0x9C,0xC8,0xC8,0xC8,0xC8,0xC8,0xDF,0xDF,0xDF,0xDF,
0x26,0x20,0x2B,0x2B,0x20,0x20,0x20,0x20,0x26,0x20,0x2B,0x2B,0x20,0x20,0x20,0x20,
0x26,0x26,0x33,0x33,0x30,0x30,0x2B,0x2B,0x26,0x20,0x2B,0x2B,0x60,0x60,0x60,0x60,
0xC2,0xC2,0xC0,0xC0,0x99,0x99,0x8B,0x8B,0x8B,0x93,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,
0xDF,0xC0,0x99,0x93,0x90,0x8B,0x80,0x80,0x80,0x86,0x90,0x90,0x90,0x90,0x90,0x90,
0x88,0x96,0x9C,0xC0,0x9C,0x9C,0x96,0x88,0x88,0x88,0x88,0xDF,0x88,0x96,0x9C,0xC0,
0xC8,0xD0,0xD0,0xCB,0x9C,0x9C,0x9C,0x9C,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,
0x96,0x9C,0xC0,0xC0,0x9C,0x9C,0x96,0x96,0x93,0x96,0xC0,0xC0,0x9C,0x9C,0x9C,0x9C,
0x93,0x96,0x9C,0x9C,0x96,0x96,0x93,0x93,0x8D,0x93,0x9C,0x9C,0x96,0x96,0x96,0x96,
0x90,0x90,0xC0,0xC0,0xC0,0xC0,0xC6,0xC6,0xC6,0xC6,0xC4,0xC4,0xC0,0xC0,0xC0,0xC0,
0x9C,0xC0,0xC4,0xC4,0xC4,0xC0,0x99,0x99,0xC0,0xC0,0x90,0x90,0x90,0x90,0x90,0xDF,
0xC6,0xC6,0xC0,0x90,0x90,0x90,0x90,0xDF,0x90,0xC0,0xC6,0xC4,0xC0,0xC4,0xC4,0x9C,
0x90,0x90,0x90,0x90,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF
#endif /* 32MELODY */
};

#define CLOCK_FREQ 1000000 /* 1MHz */

/* Длительность периода 12 нот */
#define G_PERIOD      (uint16_t)(CLOCK_FREQ/392.00) // Соль
#define G_HASH_PERIOD (uint16_t)(CLOCK_FREQ/415.30) // Соль диез
#define A_PERIOD      (uint16_t)(CLOCK_FREQ/440.00) // Ля
#define A_HASH_PERIOD (uint16_t)(CLOCK_FREQ/466.16) // Си бемоль
#define B_PERIOD      (uint16_t)(CLOCK_FREQ/493.88) // Си
#define C_PERIOD      (uint16_t)(CLOCK_FREQ/523.25) // До
#define C_HASH_PERIOD (uint16_t)(CLOCK_FREQ/554.36) // До диез
#define D_PERIOD      (uint16_t)(CLOCK_FREQ/587.32) // Ре
#define D_HASH_PERIOD (uint16_t)(CLOCK_FREQ/622.26) // Ре диез
#define E_PERIOD      (uint16_t)(CLOCK_FREQ/659.26) // Ми
#define F_PERIOD      (uint16_t)(CLOCK_FREQ/698.46) // Фа
#define F_HASH_PERIOD (uint16_t)(CLOCK_FREQ/739.98) // Фа
#define PAUSE_PERIOD  (uint16_t)(CLOCK_FREQ/4000)   // Pause
#define VIBRATO_STROBE (uint16_t)(CLOCK_FREQ*120.0/1000000) /* 120uS */


#define T0_FREQ (uint16_t)(CLOCK_FREQ/8/256) /* Interrupt frequency */
#define VIBRATO_INTERVAL    (uint16_t)(T0_FREQ*50.0/1000) /* 50mS */
#define SHORT_NOTE_INTERVAL (uint16_t)(T0_FREQ*260.0/1000) /* 260mS */
#define LONG_NOTE_INTERVAL  (uint16_t)(T0_FREQ*400.0/1000) /* 260mS */

#define MELODY_MASK (sizeof(MelodyArray)/32-1)


volatile uint16_t Period = 0;
volatile uint16_t MelodyStart = 0; /* (0 - 63)*32 */
volatile uint8_t  NoteNumber; /* 0 - 31 */
volatile uint8_t  VibratoFlag; /* Next period must be increased */
#define MELODY_END    2
#define MELODY_PLAING 1  /* The melody is plaing */
volatile uint8_t  MelodyState = 0;
volatile uint8_t  NoteLengthCounter;
volatile uint8_t  VibratoCounter;
uint8_t  Note;
volatile uint8_t MelodyNumber;
volatile uint8_t Flag2ms;

/* Прерывание вызывается в начале периода при необходимости
 перестроить параметры воспроизведения ноты */
INTERRUPT_HANDLER(TIM1_OVR_UIF_handle,TIM1_OVR_UIF_vector)
{
  uint16_t Tmp;

  TIM1->SR1 = 0;
  /* Полпериода длительность включенного совтояния */
  Tmp = Period/2;
  TIM1->CCR3H = Tmp >> 8;
  TIM1->CCR3L = Tmp & 0xFF;
  /* ШИМ перестроен */
  
  /* Длительность периода - период таймера */
  /* Период уменьшается на 1/8 при включении строба вибрато */
  if (VibratoFlag)
  {
    Tmp = Period - VIBRATO_STROBE;
    VibratoFlag = 0; /* В следующий период будет загружена обычная длительность периода */
  }
  else
  {
    Tmp = Period - 1;
    TIM1->IER   = 0; /* Выключение прерывания T1 */
  }
  TIM1->ARRH = Tmp >> 8;
  TIM1->ARRL = Tmp & 0xFF;
  /* Период перестроен */
}

/* Получение длительности периода ноты */
static uint16_t GetNotePeriod(uint8_t _Note)
{
  _Note = _Note & NOTE_MASK;
  switch (_Note)
  {
    case 0: //Соль
      return G_PERIOD;
    case 2: //Соль#
      return G_HASH_PERIOD;
    case 4: //Ля
      return A_PERIOD;
    case 6: //Ля#
      return A_HASH_PERIOD;
    case 8: //Си
    case 9: 
      return B_PERIOD;
    case 11: //До
      return C_PERIOD;
    case 13: //До#
      return C_HASH_PERIOD;
    case 16: //Ре
      return D_PERIOD;
    case 19: //Ре#
      return D_HASH_PERIOD;
    case 22: //Ми
      return E_PERIOD;
    case 25: //Фа
      return F_PERIOD;
    case 28: //Фа#
      return F_HASH_PERIOD;
   } //switch
   return PAUSE_PERIOD;
}

/* Every 2mS */
INTERRUPT_HANDLER(TIM4_OVR_UIF_handler,TIM4_OVR_UIF_vector)
{
  TIM4->SR1 = 0;

  Flag2ms++;
  
  /* Флаг запуска мелодии не установлен - ничего не делать */
  if (MelodyState != MELODY_PLAING)
    return;

  NoteLengthCounter--;
  /* Нота проигралась */
  if (NoteLengthCounter == 0) /* The note is end */
  {
    if (NoteNumber < 32)
    { 
      {
        uint8_t Tmp = NoteNumber;
        Note = MelodyArray[MelodyStart + Tmp];
        /* Получили описание ноты */
      }

      NoteNumber++;

      Period = GetNotePeriod(Note);
      if (Period == PAUSE_PERIOD)
      {
        VibratoCounter = 0xFF; // Off vibrato on pause 
        TIM1->CCR3H = 0xFF;
        TIM1->CCR3L = 0xFF; /* Off the output. PWM with 0 duty */
        TIM1->IER   = 0; /* Выключение прерывания T1 */
        /* В паузе ШИМ не будет генерироваться поскольку счетчик никогда не
         досчитает до 0xFFFF - его период всегда меньше */
      }
      else /* Pause */
      {
        if (Note & NOTE_OCTAVE)
        {
          Period = Period/2; /* Увеличение частоты в 2 раза */
        }
        if (Note & NOTE_VIBRATO)
          VibratoCounter = VIBRATO_INTERVAL;
        else
          VibratoCounter = 0xFF;
        TIM1->SR1 = 0; /* Clear all interrupt flags */
        TIM1->IER = TIM1_IER_UIE; /* Enable interrupt*/
        /* Как только будет доигран период произойдет прерывание и
          Новые настройки будут загружены в таймер в обработчике */
      } /* !Pause */
      if (Note & NOTE_SHORT)
        NoteLengthCounter = SHORT_NOTE_INTERVAL;
      else
        NoteLengthCounter = LONG_NOTE_INTERVAL;
      /* Следующий раз в нестройку ноты мы попадем через вот этот интервал
        == длительность ноты */
    }
    else /* End of melody */
    {
      TIM1->CCR3H = 0xFF;
      TIM1->CCR3L = 0xFF; /* Off the output. PWM with 0 duty */
      TIM1->IER   = 0; /* Выключение прерывания T1 */
      MelodyState = MELODY_END;
    }

    return;
  }
  if (VibratoCounter != 0xFF) /* Vibrato is on */
  {
    VibratoCounter--;
    if (VibratoCounter)
      return;
    VibratoCounter = VIBRATO_INTERVAL;
    VibratoFlag = 1;
    TIM1->SR1 = 0; /* Clear all interrupt flags */
    TIM1->IER = TIM1_IER_UIE; /* Enable interrupt*/
    /* Выбрато периодически чуть чуть уменьшает период ноты.
      Когда наступает этот мемент включаем необходимость перестройки */
  }
}


#define EEPROM_SIZE 128
uint8_t* EepRom = (uint8_t*)0x4000;
uint8_t RandomValue;
uint8_t FirstBit = 0;
uint8_t NextEepRom;
int8_t  Direction = -1;

INTERRUPT_HANDLER(AWU_handler, AWU_vector)
{
  AWU->CSR &= ~AWU_CSR_AWUEN; /* Disable AWU  & clear interrupt flag */
}

volatile uint8_t I_Flag = 0;

INTERRUPT_HANDLER(EXTI_PORTB_handler, EXTI_PORTB_vector)
{
  I_Flag = 1;
  /* None */
}


void ReadMelodyNumber()
{
  uint8_t i;
  
  FirstBit = EepRom[1]&0x80;

  for (i = 1; i < EEPROM_SIZE; i++)
  {
    if(FirstBit != (EepRom[i] & 0x80))
    {
      goto SetNext;
    }
    MelodyNumber = (EepRom[i] & MELODY_MASK);
  }
  i = 1; /* First array item */
  FirstBit ^= 0x80;
SetNext:
  NextEepRom = i;
}


uint8_t RunNextMelody = 0;

void main( void )
{
  //Настройка входов и выходов
  GPIOC->DDR = 
            GPIO_PIN3/* T1_CH3*/
          |GPIO_PIN4/* T1_CH4*/;

  GPIOC->CR1 = /* Push-pull */
            GPIO_PIN3/* T1_CH3*/
          |GPIO_PIN4/* T1_CH4*/;

  GPIOB->CR1 =             
            GPIO_PIN4/* PULLUP bell button, voltage detector*/
          |GPIO_PIN5/* PULLUP random melody switch */;

  GPIOD->ODR = GPIO_PIN4; /* power on */
  GPIOD->DDR = GPIO_PIN3 /* T2C2 pwm */
          |GPIO_PIN4 /* Power off */;
  GPIOD->CR1 = GPIO_PIN3|GPIO_PIN4;

  EXTI->CR1 = EXTI_CR1_PBIS; /* Прерывание по обеим перепадам порт B Нужно включать до включения прерываний */         

  //Тактирование 8МГц при кварце 8МГц или без кварца.
  { /* Clock */
    u16 i;
    
    CLK->SWR = CLK_SWR_HSE; /* We will switch to HSE */
    i=1000;
    while(i)
    {
      i--;
      if (CLK->SWCR & CLK_SWCR_SWIF) /* Interrupt flag */
      {
        CLK->SWCR |= CLK_SWCR_SWEN; /* Change clock source TO HSE */
        CLK->CKDIVR = 0; /* 8Mhz external */
        goto ClockOk;
      }
    }
    /* The cristal is absent */
    CLK->CKDIVR = CLK_CKDIVR_HSIDIV2; /* 8Mhz HSI */
ClockOk:
    /* Выбор периферии */
    CLK->PCKENR1 = CLK_PCKENR1_TIM1 | CLK_PCKENR1_TIM2 | CLK_PCKENR1_TIM4;
    CLK->PCKENR2 = CLK_PCKENR2_ADC|CLK_PCKENR2_AWU;
    CLK->ICKR    |= CLK_ICKR_LSIEN; /* ON LSI 128K */
  }
  
  ADC1->TDRL = (1<<3); /* 3-th ADC channel PD2 */
  ADC1->CSR  = (1<<3); /* 3-th channel */
  ADC1->CR1  = ADC1_CR1_ADON; /* 4MHz, 0n */
  ADC1->CR2  = ADC1_CR2_ALIGN; /* Right alignment */

  //Настройка прерываний и таймеров
  // T1 CH3 - выходной PWM звонка
  TIM1->ARRH = 0; 
  TIM1->ARRL = 4; /* 4 tick period - it is wery fast */
  TIM1->CCR3H = 0xFF;
  TIM1->CCR3L = 0xFF; /* PWM is OFF */
  TIM1->PSCRL = 7; /* Timer clock 1MHz */
  TIM1->CCMR3 = TIM1_CCMR_OCM_PWM2; /* PWM2 mode */
  TIM1->CCER2 = TIM1_CCER2_CC3E; /* Enable SCCR3 */
  TIM1->BKR = TIM1_BKR_MOE;
  TIM1->EGR = TIM1_EGR_UG;

  //TIM4 - 2 ms периодический таймер
  TIM4->PSCR = 6; /* 8Mhz / 2^6 (64) = 125 kHz */
  TIM4->ARR = 0xFF; /* 125kHz/256 = 488Hz it is 2mS interrupt interval */
  TIM4->IER = TIM4_IER_UIE; /* Update interrupt enable */

  //TIM2 ch2 - pwm громкости
  TIM2->ARRH = 0; 
  TIM2->ARRL = 7; /* Всего 8 уровней громкости - 1Mhz out*/
  TIM2->CCR2H = 0;
  TIM2->CCR2L = (EepRom[0] & 7 ); /* В первом байте eeprom хранится уровень громкости */
  TIM2->PSCR = 0; /* Timer period 1us */
  TIM2->CCMR2 = TIM2_CCMR_OCM_PWM1; /* PWM1 mode */
  TIM2->CCER1 = TIM2_CCER1_CC2E; /* Enable SCCR1 */
  TIM2->EGR = TIM1_EGR_UG;
   
  MelodyState = 0;
  enableInterrupts();

  TIM1->CR1 |= TIM1_CR1_CEN ;
  TIM4->CR1 |= TIM4_CR1_CEN ;
  TIM2->CR1 |= TIM2_CR1_CEN ;

  while (1) //
  {
    // Read adc to set random value
    if (ADC1->CSR & ADC1_CSR_EOC)
    {
      ADC1->CSR &= ~ADC1_CSR_EOC;
      RandomValue += ADC1->DRL;
      ADC1->CR1 |= ADC1_CR1_ADON; /* start */     
    }

    if(Flag2ms)
    {
      ADC1->CR1 |= ADC1_CR1_ADON; /* start */
      EventKeys();
      Flag2ms = 0;
      while (EventQueue)
      {
        RunNextMelody = 1;
        if ((EventQueue & EV_MASK ) == EV_KEY_REALIZED) /* Short key pressed */
        {
          goto ChangeVolume;
        }
        if ((EventQueue & EV_MASK) == EV_KEY_LONG) /* long key pressed */
        {
          Direction = Direction * -1;
          goto ChangeVolume;
        }

EndChangeVolume:
        EventQueue = 0;
        break;
ChangeVolume:
        {
          int8_t Volume = TIM2->CCR2L + Direction;

          if (Volume >= 0 && Volume <= 7)
          {
            TIM2->CCR2H = 0;
            TIM2->CCR2L = Volume;
          }
        }
        goto EndChangeVolume;
      }
    }

    if ( MelodyState == 0 ) /* Мелодия не включена -включить мелодию */
    {
      ReadMelodyNumber();
      MelodyStart = (MelodyNumber & MELODY_MASK)*32;
      NoteNumber = 0;
      NoteLengthCounter = 1;
      MelodyState = MELODY_PLAING;
    }
    else if (MelodyState == MELODY_END) /* Мелодия закончилась */
    {   
      {
        /* Выбрать следующую мелодию */
        if ((GPIOD->IDR & GPIO_PIN5) == 0) /* Random melody */
        {
          MelodyNumber = RandomValue & MELODY_MASK;
        }
        else
        {
          MelodyNumber = (MelodyNumber+1) & MELODY_MASK;
        }

        /* Unlock the EEPROM */
        FLASH->DUKR = 0xAE;
        FLASH->DUKR = 0x56;
        
        /* Сохранение номера мелодии в энергонезависимой памяти */
        /* TODO: ресурс eeprom расходуестя если работать без отключения */
        EepRom[NextEepRom] = MelodyNumber | FirstBit;
        if (TIM2->CCR2L != EepRom[0]) /* Volume saving */
        {
          EepRom[0] = TIM2->CCR2L;
        }
        FLASH->IAPSR = 0;
      }

      GPIOD->ODR &= ~GPIO_PIN4; /* Выключить питание. То есть 
          включить оптрон, который притянет затвор транзистора питания к земле */

      AWU->TBR = 0x0B; /* 1011 - 2^10 - 512 mS */
      AWU->APR = 0x3E; /* 64 */
      AWU->CSR = AWU_CSR_AWUEN; 

      /* Ждать */
      halt();
      AWU->CSR &= ~AWU_CSR_AWUEN; /* Disable AWU  & clear interrupt flag */

      /* В этот момент питание должно отключиться , если кнопка не нажата.
      Если же она нажата то питание появится снова по отключению оптрона */
      /* Включить прерывания от PB4 - детектор напряжения на трансформаторе */
      GPIOB->CR2 = GPIO_PIN4;    
      GPIOD->ODR = GPIO_PIN4; /* выключить оптрон. Если через кнопку проходит ток то снова появится питание трансформатора */
      
      /* Если пин притянут к земле, то питания нет. Если же напряжение подается постоянно - то если на этом пине напряжение, то еще звонят в звонок */
      if (((GPIOB->IDR & GPIO_PIN4) == 0) /* этот пин притянут к земле - нет питания на трансформатора */
          && (RunNextMelody == 0) ) /* Не была нажата ни одна клавиша во время проигрывания мелодии */

      {
        /*  Уснуть до тех пор пока не появится питание. Если конденсатор разрядится и питания не появится совсем, то программа 
        начнет работы заново при очередном включении питания (переключении уровня на PB4) */
        halt(); /* So the halt can wake up only by EXTI interrupt */
//        while (I_Flag == 0);
        //I_Flag = 0;
      }
      /* Если мы оказались здесь, то значит питание включилось или не выключалось вовсе */
      GPIOB->CR2 = 0; /* Выключить прерывания от детектора напряжения */
      MelodyState = 0; /* Продолжить воспроизведение след мелодии */
      RunNextMelody = 0;
      continue;
    }
  } //while (1)
}
